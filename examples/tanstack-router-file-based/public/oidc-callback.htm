<!doctype html>
<html>

<body>
    <!-- oidc-spa file. Do not remove, do not edit -->
    <script>
        if (localStorage.getItem("oidc-spa.callback-file-version") !== "2") {
            alert("Your oidc-callback.htm file is outdated. Please update it. https://docs.oidc-spa.dev/v/v6");
        }
        const reloadOnRestore = () => {
            const listener = () => {
                if (document.visibilityState === "visible") {
                    document.removeEventListener("visibilitychange", listener);
                    // TODO: Debug, remove
                    console.log("we got a restore, reloading");
                    location.reload();
                }
            };
            document.addEventListener("visibilitychange", listener);
        };

        main: {

            const authResponse = {};
            for (const [key, value] of new URL(location.href).searchParams) {
                authResponse[key] = value;
            }

            // TODO: Remove, debug
            if (!("state" in authResponse)) {
                alert("no state in url");
            }

            const data = (() => {
                const json = localStorage.getItem(`oidc.${authResponse.state}`);

                if (json === null) {
                    return undefined;
                }

                const { data } = JSON.parse(json);

                if (data === null) {
                    return undefined;
                }

                return data;

            })();

            if (data === undefined) {
                console.log("no data");
                reloadOnRestore();
                const KEY = "oidc-spa.has-navigated-back";
                if (sessionStorage.getItem(KEY) === "true") {
                    sessionStorage.removeItem(KEY);
                    history.forward();
                } else {
                    sessionStorage.setItem(KEY, "true");
                    history.back();
                }
                break main;
            }

            if (data.isSilentSso) {
                console.log("silent sso");
                parent.postMessage(authResponse, location.origin);
            } else {
                console.log("not silent sso");
                reloadOnRestore();
                sessionStorage.setItem(`oidc-spa.authResponse`, JSON.stringify(authResponse));
                location.href = data.redirectUrl;
            }
        }
    </script>
</body>

</html>